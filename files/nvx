#!/usr/bin/env bash
set -euo pipefail

KALI="Kali"
SIFT="sift-lab"

usage() { echo "Uso: nvx <comando> [args...]" >&2; exit 2; }
[[ $# -ge 1 ]] || usage

cmd="$1"; shift || true
args=("$@")

# 1) Se esiste sull'host: sudo host (password host se serve)
if command -v -- "$cmd" >/dev/null 2>&1; then
  exec sudo "$cmd" "${args[@]}"
fi

# helper: verifica comando nel container (da utente)
has_in_container() {
  local target="$1"
  distrobox-enter --root "$target" -- sh -lc "command -v '$cmd' >/dev/null 2>&1"
}

# helper: esegue sudo dentro il container (interattivo, chiede password del container)
run_sudo_in_container() {
  local target="$1"
  exec distrobox-enter --root "$target" -- sudo "$cmd" "${args[@]}"
}

# 2) Resolve: Kali -> SIFT
if has_in_container "$KALI"; then
  run_sudo_in_container "$KALI"
fi

if has_in_container "$SIFT"; then
  run_sudo_in_container "$SIFT"
fi

echo "Comando '$cmd' non trovato su host, n� in $KALI, n� in $SIFT." >&2
exit 127
