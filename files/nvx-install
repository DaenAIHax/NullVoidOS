#!/usr/bin/env bash
set -euo pipefail

action="$(basename "$0")"
pkg="${1:-}"
[[ -n "$pkg" ]] || { echo "Usage: $action <package>" >&2; exit 2; }

# ---------------- list containers ----------------
mapfile -t ITEMS < <(
  distrobox list --no-color 2>/dev/null | awk '
    NR==1 { for (i=1;i<=NF;i++) if ($i=="NAME") col=i; next }
    NR>1 && col>0 { print "rootless\t"$col }
  '
  distrobox list --root --no-color 2>/dev/null | awk '
    NR==1 { for (i=1;i<=NF;i++) if ($i=="NAME") col=i; next }
    NR>1 && col>0 { print "rootful\t"$col }
  '
)

echo "Which container?"
select sel in "${ITEMS[@]}"; do
  [[ -n "$sel" ]] && break
done

mode="${sel%%$'\t'*}"
name="${sel#*$'\t'}"

# ---------------- detect pkg manager ----------------
detect_mgr() {
  local enter="$1"
  eval "$enter sh -lc '
    if command -v apt-get >/dev/null; then echo apt;
    elif command -v dnf >/dev/null; then echo dnf;
    elif command -v pacman >/dev/null; then echo pacman;
    elif command -v apk >/dev/null; then echo apk;
    elif command -v zypper >/dev/null; then echo zypper;
    else echo unknown; fi
  '"
}

enter="distrobox-enter $name --"
[[ "$mode" == "rootful" ]] && enter="distrobox-enter --root $name --"

mgr="$(detect_mgr "$enter")"
[[ "$mgr" != "unknown" ]] || { echo "Unknown package manager." >&2; exit 1; }

# ---------------- build command ----------------
case "$mgr" in
  apt)    cmd="apt-get update && apt-get ${action/install/remove} -y $pkg" ;;
  dnf)    cmd="dnf ${action/install/remove} -y $pkg" ;;
  pacman) cmd="pacman -S${action/install/-Rns} --noconfirm $pkg" ;;
  apk)    cmd="apk ${action/install/add/del} $pkg" ;;
  zypper) cmd="zypper ${action/install/remove} -y $pkg" ;;
esac

echo "${action/install/Installing}/${action/remove/Removing} $pkg in $name ($mode)..."

if [[ "$mode" == "rootful" ]]; then
  DBX_CMD_TARGET="$name" nvx sh -lc "$cmd"
else
  distrobox-enter "$name" -- sh -lc "
    if command -v sudo >/dev/null; then sudo sh -lc '$cmd';
    elif command -v doas >/dev/null; then doas sh -lc '$cmd';
    else echo 'No sudo/doas in rootless container'; exit 1; fi
  "
fi
