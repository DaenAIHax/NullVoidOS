#!/usr/bin/env bash
set -euo pipefail

pkg="${1:-}"
if [[ -z "$pkg" ]]; then
  echo "Usage: nvx-install <package>" >&2
  exit 2
fi

# -------- list containers --------
mapfile -t ITEMS < <(
  distrobox list --no-color 2>/dev/null | awk '
    NR==1 { for (i=1;i<=NF;i++) if ($i=="NAME") col=i; next }
    NR>1 && col>0 && $col!="" { print "rootless\t"$col }
  '
  distrobox list --root --no-color 2>/dev/null | awk '
    NR==1 { for (i=1;i<=NF;i++) if ($i=="NAME") col=i; next }
    NR>1 && col>0 && $col!="" { print "rootful\t"$col }
  '
)

[[ "${#ITEMS[@]}" -gt 0 ]] || { echo "No distrobox containers found."; exit 1; }

echo "Which container?"
select sel in "${ITEMS[@]}"; do
  [[ -n "${sel:-}" ]] && break
done

mode="${sel%%$'\t'*}"
name="${sel#*$'\t'}"

enter() {
  if [[ "$mode" == "rootful" ]]; then
    distrobox-enter --root "$name" -- "$@"
  else
    distrobox-enter "$name" -- "$@"
  fi
}

# -------- already installed? --------
if enter sh -lc "command -v '$pkg' >/dev/null 2>&1"; then
  echo "✔ '$pkg' già presente in $name ($mode)"
  exit 0
fi

# -------- detect package manager --------
mgr="$(enter sh -lc '
  if command -v apt-get >/dev/null 2>&1; then echo apt;
  elif command -v dnf >/dev/null 2>&1; then echo dnf;
  elif command -v pacman >/dev/null 2>&1; then echo pacman;
  elif command -v apk >/dev/null 2>&1; then echo apk;
  elif command -v zypper >/dev/null 2>&1; then echo zypper;
  else echo unknown; fi
')"

[[ "$mgr" != "unknown" ]] || { echo "Unknown package manager in $name"; exit 1; }

case "$mgr" in
  apt)     cmd="apt-get update && apt-get install -y '$pkg'" ;;
  dnf)     cmd="dnf install -y '$pkg'" ;;
  pacman)  cmd="pacman -Sy --noconfirm '$pkg'" ;;
  apk)     cmd="apk add '$pkg'" ;;
  zypper)  cmd="zypper install -y '$pkg'" ;;
esac

echo "nvx-install $pkg in $name ($mode) [$mgr]..."

enter sh -lc "
  if command -v sudo >/dev/null 2>&1; then
    sudo sh -lc \"$cmd\"
  elif command -v doas >/dev/null 2>&1; then
    doas sh -lc \"$cmd\"
  else
    echo 'ERROR: sudo/doas not available in this container.' >&2
    exit 1
  fi
"

