#!/usr/bin/env bash
set -euo pipefail

# ---- anti-recursion guard ----
if [[ "${NVX_WHERE_GUARD:-}" == "1" ]]; then
  exit 0
fi
export NVX_WHERE_GUARD=1

needle="${1:-}"
[[ -n "$needle" ]] || { echo "Usage: nvx-where <command>" >&2; exit 2; }

print_header() { printf "TARGET\tFOUND\tPATH\n"; }
print_header

any=0

# ---- host check ----
if p="$(command -v -- "$needle" 2>/dev/null)"; then
  printf "HOST\tyes\t%s\n" "$p"
  any=1
else
  printf "HOST\tno\t-\n"
fi

# Choose a "clean shell" command (prefer bash without rc files)
clean_shell_cmd() {
  # print a command that can execute: <shell> <args...> -lc "<string>"
  if command -v bash >/dev/null 2>&1; then
    printf '%s' "bash --noprofile --norc"
  else
    printf '%s' "sh"
  fi
}

# Run inside container but try hard to not source user rc / not trigger handlers
run_in_box() {
  local mode="$1" box="$2"
  local shell
  shell="$(clean_shell_cmd)"

  # disable command_not_found_handle if present, and avoid ENV/BASH_ENV sourcing
  local inner="
    unset -f command_not_found_handle 2>/dev/null || true
    export BASH_ENV=/dev/null
    export ENV=/dev/null
    command -v '$needle' 2>/dev/null || true
  "

  if [[ "$mode" == "rootful" ]]; then
    distrobox-enter --root "$box" -- env -i HOME="$HOME" PATH="/usr/sbin:/usr/bin:/sbin:/bin" \
      NVX_WHERE_GUARD=1 $shell -lc "$inner" 2>/dev/null || true
  else
    distrobox-enter "$box" -- env -i HOME="$HOME" PATH="/usr/sbin:/usr/bin:/sbin:/bin" \
      NVX_WHERE_GUARD=1 $shell -lc "$inner" 2>/dev/null || true
  fi
}

list_names() {
  local mode="$1"
  if [[ "$mode" == "rootful" ]]; then
    distrobox list --root --no-color 2>/dev/null | awk '
      NR==1 { for (i=1;i<=NF;i++) if ($i=="NAME") col=i; next }
      NR>1 && col>0 && $col!="" { print $col }
    '
  else
    distrobox list --no-color 2>/dev/null | awk '
      NR==1 { for (i=1;i<=NF;i++) if ($i=="NAME") col=i; next }
      NR>1 && col>0 && $col!="" { print $col }
    '
  fi
}

check_box() {
  local mode="$1" box="$2"
  local p=""
  p="$(run_in_box "$mode" "$box" | head -n1 || true)"

  if [[ -n "$p" ]]; then
    printf "%s\tyes\t%s\n" "$box" "$p"
    any=1
  else
    printf "%s\tno\t-\n" "$box"
  fi
}

# rootless containers
while IFS= read -r box; do
  [[ -n "$box" ]] || continue
  check_box "rootless" "$box"
done < <(list_names rootless | sed '/^$/d')

# rootful containers
while IFS= read -r box; do
  [[ -n "$box" ]] || continue
  check_box "rootful" "$box"
done < <(list_names rootful | sed '/^$/d')

if [[ "$any" -ne 1 ]]; then
  echo "âŒ '$needle' not found on host or in any distrobox container." >&2
  exit 127
fi


  nvx-where "$1" || true
  dbx-cmd "$@"
}
