#!/usr/bin/env bash
set -uo pipefail

cmd="${1:-}"
[[ -n "${cmd}" ]] || { echo "Usage: nvx-where <command>" >&2; exit 2; }

printf "TARGET\tFOUND\tPATH\n"

any=0

if p="$(command -v -- "$cmd" 2>/dev/null)"; then
  printf "HOST\tyes\t%s\n" "$p"
  any=1
else
  printf "HOST\tno\t-\n"
fi

list_names() {
  local mode="$1"
  if [[ "$mode" == "rootful" ]]; then
    distrobox list --root --no-color 2>/dev/null | awk '
      NR==1 { for (i=1;i<=NF;i++) if ($i=="NAME") col=i; next }
      NR>1 && col>0 && $col!="" { print $col }
    '
  else
    distrobox list --no-color 2>/dev/null | awk '
      NR==1 { for (i=1;i<=NF;i++) if ($i=="NAME") col=i; next }
      NR>1 && col>0 && $col!="" { print $col }
    '
  fi
}

check_in_box() {
  local mode="$1" box="$2"
  local p=""
  if [[ "$mode" == "rootful" ]]; then
    p="$(distrobox-enter --root "$box" -- sh -lc "command -v '$cmd' 2>/dev/null || true" 2>/dev/null || true)"
  else
    p="$(distrobox-enter "$box" -- sh -lc "command -v '$cmd' 2>/dev/null || true" 2>/dev/null || true)"
  fi

  if [[ -n "$p" ]]; then
    printf "%s\tyes\t%s\n" "$box" "$p"
    any=1
  else
    printf "%s\tno\t-\n" "$box"
  fi
}

# rootless containers
while IFS= read -r box; do
  [[ -n "$box" ]] || continue
  check_in_box "rootless" "$box"
done < <(list_names rootless | sed '/^$/d')

# rootful containers
while IFS= read -r box; do
  [[ -n "$box" ]] || continue
  check_in_box "rootful" "$box"
done < <(list_names rootful | sed '/^$/d')

[[ "$any" -eq 1 ]] || { echo "âŒ '$cmd' not found on host or in any distrobox container." >&2; exit 127; }
EOF

sudo chmod 0755 /usr/local/bin/nvx-where
}


command_not_found_handle() {
  nvx-where "$1" || true
  dbx-cmd "$@"
}
